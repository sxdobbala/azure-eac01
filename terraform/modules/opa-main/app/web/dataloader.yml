- name: Copy dataloader and it's dependencies to target folder
  copy:
    src: "{{ source }}"
    dest: "{{ target }}"
    owner: "{{ default_owner }}"
    group: "{{ default_group }}"

- name: Unpack oap-configuration.zip
  unarchive:
    src: "{{ target }}/oap-configuration.zip"
    dest: "{{ target }}"
    owner: "{{ default_owner }}"
    group: "{{ default_group }}"

- name: Create application.properties
  template:
    src: resources/properties.j2
    dest: "{{ target }}/application.properties"
    owner: "{{ default_owner }}"
    group: "{{ default_group }}"
  vars:
    properties: "{{ config['dataloader_properties'] }}"

- name: Create init.d script
  template:
    src: resources/dl_service.j2
    dest: /etc/init.d/dataloader
    mode: 755

- name: Set runlevel for dataloader
  shell: |
    chkconfig --add dataloader
    chkconfig --list dataloader
    chkconfig --level 2345 dataloader on
    chkconfig --list dataloader

- name: Ensure logs directory
  file:
    path: "/var/log/opa/dataloader"
    state: directory

- name: Restart dataloader service
  command: /sbin/service dataloader restart
  args:
    warn: no

- name: Verify dataloader health
  uri:
    url: "http://localhost:8081/health"
    timeout: 60
